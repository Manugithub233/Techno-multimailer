
const marketData = {
    "ARIZONA": {
        "type": "simple",
        "to": "alik@texasmobilepcs.com",
        "cc": "alik@texasmobilepcs.com, varun@techno-communications.com, harish@techno-communications.com"
    },
    "ARKHANSAS": {
        "type": "simple",
        "to": "amirmuhammad@activewirelessllc.com",
        "cc": "mohamad@activewirelessllc.com, varun@techno-communications.com, harish@techno-communications.com"
    },
    "ATLANTA": {
        "type": "simple",
        "to": "ayan@texasmobilepcs.com",
        "cc": "mohamad@activewirelessllc.com, varun@techno-communications.com, harish@techno-communications.com"
    },
    "BAY AREA": {
        "type": "simple",
        "to": "Aous@techno-communications.com",
        "cc": "ahad@texasmobilepcs.com, faizansyed@texasmobilepcs.com, varun@techno-communications.com, harish@techno-communications.com"
    },
    "BOSTON": {
        "type": "simple",
        "to": "afzal@texasmobilepcs.com",
        "cc": "varun@techno-communications.com, harish@techno-communications.com"
    },
    "CALIFORNIA": {
        "type": "simple",
        "to": "ahad@texasmobilepcs.com",
        "cc": "varun@techno-communications.com, harish@techno-communications.com"
    },
    "CHARLOTTE": {
        "type": "simple",
        "to": "Namir@Techno-Communications.com",
        "cc": "mohamad@activewirelessllc.com, varun@techno-communications.com, harish@techno-communications.com"
    },
    "COLORADO": {
        "type": "simple",
        "to": "shahnoor@texasmobilepcs.com",
        "cc": "varun@techno-communications.com, harish@techno-communications.com"
    },
    "DALLAS": {
        "type": "complex",
        "districts": {
            "SALIM THANAWALA (DISTRICT MANAGER)": {
                "to": "salimthanawala@texasmobilepcs.com",
                "cc": "nazim@texasmobilepcs.com, varun@techno-communications.com, adrian@texasmobilepcs.com, harish@techno-communications.com"
            },
            "SHAIK MAZHAR UDDIN (DISTRICT MANAGER)": {
                "to": "imranshaikh@texasmobilepcs.com",
                "cc": "nazim@texasmobilepcs.com, varun@techno-communications.com, adrian@texasmobilepcs.com, harish@techno-communications.com"
            },
            "IMRAN AHMED MOHAMMED (DISTRICT MANAGER)": {
                "to": "Ahmedimran@texasmobilepcs.com",
                "cc": "nazim@texasmobilepcs.com, varun@techno-communications.com, adrian@texasmobilepcs.com, harish@techno-communications.com"
            },
            "ADRIAN (CAMS TECHNICIAN)": {
                "to": "adrian@texasmobilepcs.com",
                "cc": "nazim@texasmobilepcs.com, varun@techno-communications.com, harish@techno-communications.com"
            }
        }
    },
    "DALLAS/OK": {
        "type": "simple",
        "to": "nazim@texasmobilepcs.com",
        "cc": "varun@techno-communications.com, harish@techno-communications.com"
    },
    "EAST BAY AREA": {
        "type": "simple",
        "to": "saad@activewirelessllc.com",
        "cc": "ahad@texasmobilepcs.com, faizansyed@texasmobilepcs.com, varun@techno-communications.com, harish@techno-communications.com"
    },
    "EL PASO": {
        "type": "simple",
        "to": "haroon@texasmobilepcs.com",
        "cc": "adnan@texasmobilepcs.com, varun@techno-communications.com, harish@techno-communications.com"
    },
    "HOUSTON": {
        "type": "complex",
        "districts": {
            "SAAD NADEEM (COMPLIANCE MANAGER)": {
                "to": "snadeem@texasmobilepcs.com",
                "cc": "adnan@texasmobilepcs.com, varun@techno-communications.com, haseeb@techno-communications.com, harish@techno-communications.com"
            },
            "ADNAN BARRI (MARKET MANAGER)": {
                "to": "adnan@texasmobilepcs.com",
                "cc": "varun@techno-communications.com, snadeem@texasmobilepcs.com, haseeb@techno-communications.com, harish@techno-communications.com"
            },
            "ZUBAIR HUSSAIN (DISTRICT MANAGER)": {
                "to": "zubair@texasmobilepcs.com",
                "cc": "adnan@texasmobilepcs.com, varun@techno-communications.com, snadeem@texasmobilepcs.com, haseeb@techno-communications.com, harish@techno-communications.com"
            },
            "Shahrukh Khalid (DISTRICT MANAGER)": {
                "to": "shahrukh@texasmobilepcs.com",
                "cc": "adnan@texasmobilepcs.com, varun@techno-communications.com, snadeem@texasmobilepcs.com, haseeb@techno-communications.com, harish@techno-communications.com"
            },
            "SALMAN SHAREEF (DISTRICT MANAGER)": {
                "to": "smohammed@texasmobilepcs.com",
                "cc": "adnan@texasmobilepcs.com, varun@techno-communications.com, snadeem@texasmobilepcs.com, haseeb@techno-communications.com, harish@techno-communications.com"
            },
            "HASEEB (COMPLIANCE MANAGER)": {
                "to": "haseeb@techno-communications.com",
                "cc": "adnan@texasmobilepcs.com, varun@techno-communications.com, snadeem@texasmobilepcs.com, harish@techno-communications.com"
            },
            "SALMAN RIAZ (DISTRICT MANAGER)": {
                "to": "salman@texasmobilepcs.com",
                "cc": "adnan@texasmobilepcs.com, varun@techno-communications.com, snadeem@texasmobilepcs.com, haseeb@techno-communications.com, harish@techno-communications.com"
            }
        }
    },
    "INDIA": {
        "type": "simple",
        "to": "varun@techno-communications.com",
        "cc": "harish@techno-communications.com"
    },
    "LOS ANGELES": {
        "type": "complex",
        "districts": {
            "FAIZAN SYED (COMPLIANCE MANAGER)": {
                "to": "faizansyed@texasmobilepcs.com",
                "cc": "ahad@texasmobilepcs.com, varun@techno-communications.com, harish@techno-communications.com"
            },
            "SUBHAN ANSARI (MARKET MANAGER)": {
                "to": "subhan@techno-communications.com",
                "cc": "ahad@texasmobilepcs.com, faizansyed@texasmobilepcs.com, varun@techno-communications.com, harish@techno-communications.com"
            },
            "ABDUL RAFAY ASHRAF (MARKET MANAGER)": {
                "to": "rafay@techno-communications.com",
                "cc": "ahad@texasmobilepcs.com, faizansyed@texasmobilepcs.com, varun@techno-communications.com, harish@techno-communications.com"
            },
            "SHARIK THOBANI (MARKET MANAGER)": {
                "to": "sharik@texasmobilepcs.com",
                "cc": "ahad@texasmobilepcs.com, faizansyed@texasmobilepcs.com, varun@techno-communications.com, harish@techno-communications.com"
            },
            "MAAZ KHAN (MARKET MANAGER)": {
                "to": "maaz@texasmobilepcs.com",
                "cc": "ahad@texasmobilepcs.com, faizansyed@texasmobilepcs.com, varun@techno-communications.com, harish@techno-communications.com"
            }
        }
    },
    "MEMPHIS": {
        "type": "complex",
        "districts": {
            "AMIR MUHAMMAD (DISTRICT MANAGER)": {
                "to": "amirmuhammad@activewirelessllc.com",
                "cc": "mohamad@activewirelessllc.com, varun@techno-communications.com, harish@techno-communications.com"
            },
            "SHOAIB SHEERAZ (DISTRICT MANAGER)": {
                "to": "shoaib@activewirelessllc.com",
                "cc": "mohamad@activewirelessllc.com, varun@techno-communications.com, harish@techno-communications.com"
            },
            "ZAID WASEEM (DISTRICT MANAGER)": {
                "to": "zaid@activewirelessllc.com",
                "cc": "mohamad@activewirelessllc.com, varun@techno-communications.com, harish@techno-communications.com"
            }
        }
    },
    "NASHVILLE": {
        "type": "simple",
        "to": "anas@texasmobilepcs.com",
        "cc": "mohamad@activewirelessllc.com, varun@techno-communications.com, harish@techno-communications.com"
    },
    "NORTH BAY AREA": {
        "type": "simple",
        "to": "sumair@texasmobilepcs.com",
        "cc": "ahad@texasmobilepcs.com, faizansyed@texasmobilepcs.com, varun@techno-communications.com, harish@techno-communications.com"
    },
    "NORTH CAROLINA": {
        "type": "complex",
        "districts": {
            "UZAIR UDDIN (MARKET MANAGER)": {
                "to": "uzair@activewirelessllc.com",
                "cc": "mohamad@activewirelessllc.com, varun@techno-communications.com, harish@techno-communications.com"
            },
            "HASSAN TANVEER (DISTRICT MANAGER)": {
                "to": "Tanveer@activewirelessllc.com",
                "cc": "mohamad@activewirelessllc.com, varun@techno-communications.com, harish@techno-communications.com"
            },
            "ALI RIZVI (DISTRICT MANAGER)": {
                "to": "Rizvi@activewirelessllc.com",
                "cc": "mohamad@activewirelessllc.com, varun@techno-communications.com, harish@techno-communications.com"
            }
        }
    },
    "OREGON": {
        "type": "simple",
        "to": "prabhakar@techno-communications.com",
        "cc": "varun@techno-communications.com, harish@techno-communications.com"
    },
    "OXNARD/PALMDALE": {
        "type": "simple",
        "to": "aslam@techno-communications.com",
        "cc": "varun@techno-communications.com, harish@techno-communications.com"
    },
    "PHILLY": {
        "type": "simple",
        "to": "anas@texasmobilepcs.com",
        "cc": "mohamad@activewirelessllc.com, varun@techno-communications.com, harish@techno-communications.com"
    },
    "SACRAMENTO": {
        "type": "complex",
        "districts": {
            "TALHA QURESHI (MARKET MANAGER)": {
                "to": "tqureshi@texasmobilepcs.com",
                "cc": "varun@techno-communications.com, harish@techno-communications.com"
            },
            "HAFIZ ASAD BURGEES (DISTRICT MANAGER)": {
                "to": "asad@technocallc.com",
                "cc": "tqureshi@texasmobilepcs.com, varun@techno-communications.com, harish@techno-communications.com"
            },
            "SYED JAFFER ADNAN (DISTRICT MANAGER)": {
                "to": "JafferAdnan@technocallc.com",
                "cc": "tqureshi@texasmobilepcs.com, varun@techno-communications.com, harish@techno-communications.com"
            }
        }
    },
    "SAN DIEGO": {
        "type": "simple",
        "to": "saleem@texasmobilepcs.com",
        "cc": "ahad@texasmobilepcs.com, faizansyed@texasmobilepcs.com, varun@techno-communications.com, harish@techno-communications.com"
    },
    "UTAH": {
        "type": "simple",
        "to": "Abdullah@technocommunicationsllc.com",
        "cc": "varun@techno-communications.com, harish@techno-communications.com"
    }
};

// DOM Elements
const marketSelect = document.getElementById('marketSelect');
const selectionArea = document.getElementById('selectionArea');
const tileContainer = document.getElementById('tileContainer');
const toggleAllBtn = document.getElementById('toggleAllBtn');
const previewConsole = document.getElementById('previewConsole');
const displayTo = document.getElementById('displayTo');
const displayCc = document.getElementById('displayCc');
const launchBtn = document.getElementById('launchBtn');

let currentRecipients = { to: [], cc: [] };

// Initialize Dropdown
Object.keys(marketData).sort().forEach(market => {
    const opt = document.createElement('option');
    opt.value = market;
    opt.textContent = market;
    marketSelect.appendChild(opt);
});

// Market Change Event
marketSelect.addEventListener('change', function() {
    const data = marketData[this.value];
    
    // Reset UI
    tileContainer.innerHTML = '';
    selectionArea.classList.add('hidden');
    previewConsole.classList.add('hidden');
    currentRecipients = { to: [], cc: [] };
    launchBtn.disabled = true;

    if (data.type === 'complex') {
        selectionArea.classList.remove('hidden');
        renderTiles(data.districts);
        updateToggleBtnText();
    } else {
        previewConsole.classList.remove('hidden');
        launchBtn.disabled = false;
        updatePreview(data.to, data.cc);
    }
});

function renderTiles(districts) {
    Object.keys(districts).forEach(distName => {
        const tile = document.createElement('div');
        tile.className = 'tile rounded-xl p-4 cursor-pointer flex items-center justify-between group h-full'; 
        tile.dataset.value = distName;
        
        tile.innerHTML = `
            <div class="flex items-center gap-3 overflow-hidden">
                <div class="w-10 h-10 rounded-full bg-slate-100 flex-shrink-0 flex items-center justify-center text-slate-400 group-[.selected]:bg-indigo-100 group-[.selected]:text-indigo-600 transition-colors">
                    <i class="fa-solid fa-user"></i>
                </div>
                <span class="text-sm font-semibold text-slate-700 break-words leading-tight group-[.selected]:text-indigo-700">${distName}</span>
            </div>
            <div class="w-6 h-6 flex-shrink-0 rounded-full border-2 border-slate-300 group-[.selected]:border-indigo-500 group-[.selected]:bg-indigo-500 flex items-center justify-center transition-all ml-2">
                <i class="fa-solid fa-check text-white text-[10px] opacity-0 group-[.selected]:opacity-100"></i>
            </div>
        `;

        tile.addEventListener('click', () => {
            tile.classList.toggle('selected');
            calculateComplexRecipients();
        });
        tileContainer.appendChild(tile);
    });
}

function calculateComplexRecipients() {
    const marketName = marketSelect.value;
    const selectedTiles = document.querySelectorAll('.tile.selected');
    
    updateToggleBtnText();

    if (selectedTiles.length === 0) {
        previewConsole.classList.add('hidden');
        currentRecipients = { to: [], cc: [] };
        launchBtn.disabled = true;
        return;
    }

    let toList = [];
    let ccSet = new Set();

    selectedTiles.forEach(tile => {
        const distData = marketData[marketName].districts[tile.dataset.value];
        if(distData.to) toList.push(distData.to);
        if(distData.cc) {
            distData.cc.split(',').forEach(email => {
                const clean = email.trim();
                if(clean) ccSet.add(clean);
            });
        }
    });

    launchBtn.disabled = false;
    updatePreview(toList.join(', '), Array.from(ccSet).join(', '));
}

function updatePreview(to, cc) {
    previewConsole.classList.remove('hidden');
    displayTo.textContent = to || "No Recipient";
    displayCc.textContent = cc || "No CC";
    currentRecipients = { to: [to], cc: [cc] };
}

function toggleSelectAll() {
    const tiles = document.querySelectorAll('.tile');
    const selectedTiles = document.querySelectorAll('.tile.selected');
    const isAllSelected = tiles.length === selectedTiles.length;

    tiles.forEach(tile => {
        if (isAllSelected) tile.classList.remove('selected');
        else tile.classList.add('selected');
    });
    calculateComplexRecipients();
}

function updateToggleBtnText() {
    const tiles = document.querySelectorAll('.tile');
    const selectedTiles = document.querySelectorAll('.tile.selected');
    const btn = document.getElementById('toggleAllBtn');
    
    if (tiles.length > 0 && tiles.length === selectedTiles.length) {
        btn.textContent = 'DESELECT ALL';
    } else {
        btn.textContent = 'SELECT ALL';
    }
}

function generateEmail() {
    if (!currentRecipients.to[0]) return;

    const marketName = marketSelect.value;
    const today = new Date();
    const dateStr = (today.getMonth() + 1) + '/' + today.getDate() + '/' + today.getFullYear();
    const subject = `${marketName} Camera Not Working Report - ${dateStr}`;
    
    // STRUCTURED BODY WITH SIGNATURE
    const body = 
`Hi Team,

Please Find Camera Not Working Report as on ${dateStr}.

[ PASTE YOUR TABLE HERE ]

Thanks & Regards,

Boragala Bharadwaj
Techno Communications`;

    const safeSubject = encodeURIComponent(subject);
    const safeBody = encodeURIComponent(body);
    const safeTo = encodeURIComponent(currentRecipients.to[0]); 
    const safeCc = encodeURIComponent(currentRecipients.cc[0]);

    const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${safeTo}&cc=${safeCc}&su=${safeSubject}&body=${safeBody}`;
    
    window.open(gmailUrl, '_blank');
}
